<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Velocidade de Internet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gauge {
            position: relative;
            border-radius: 50%/100% 100% 0 0;
            background-color: #eee;
            overflow: hidden;
        }
        .gauge-fill {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: center top;
            transform: rotate(0.0001deg);
            transition: transform 1s ease-out;
            background-color: #3b82f6;
        }
        .gauge-center {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 20px;
            height: 20px;
            transform: translateX(-50%);
            background-color: white;
            border-radius: 50%;
        }
        .gauge-value {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            text-align: center;
            font-weight: bold;
            font-size: 1.5rem;
        }
        .gauge-label {
            position: absolute;
            bottom: -30px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-6">Teste de Velocidade de Internet</h1>
        
        <!-- Painel de Navegação -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex flex-wrap gap-2">
                <a href="index.html" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">Início</a>
                <a href="teste-seu-teclado.html" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">Teste de Teclado</a>
                <a href="teste-seu-processador.html" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">Teste de Processador</a>
                <a href="audio-microfone.html" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">Teste de Áudio</a>
                <a href="teste-touch-screen.html" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">Teste de Touch</a>
                <a href="teste-velocidade-internet.html" class="px-4 py-2 bg-blue-700 text-white rounded hover:bg-blue-800 transition">Velocidade de Internet</a>
            </div>
        </div>
        
        <!-- Informações de Conexão -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 class="text-xl font-semibold mb-2">Informações de Conexão</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p><span class="font-medium">Tipo de Conexão:</span> <span id="connection-type">Detectando...</span></p>
                    <p><span class="font-medium">Provedor:</span> <span id="isp-info">Detectando...</span></p>
                </div>
                <div>
                    <p><span class="font-medium">Endereço IP:</span> <span id="ip-address">Detectando...</span></p>
                    <p><span class="font-medium">Localização:</span> <span id="location-info">Detectando...</span></p>
                </div>
            </div>
        </div>
        
        <!-- Painel de Controle -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 class="text-xl font-semibold mb-4">Iniciar Teste</h2>
            <div class="flex flex-wrap gap-4 justify-center">
                <button id="start-test" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    Iniciar Teste Completo
                </button>
                <button id="test-download" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Testar Download
                </button>
                <button id="test-upload" class="px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" transform="rotate(180 10 10)" />
                    </svg>
                    Testar Upload
                </button>
                <button id="test-ping" class="px-6 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                    </svg>
                    Testar Ping
                </button>
            </div>
        </div>
        
        <!-- Medidores -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- Medidor de Download -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-lg font-semibold mb-4 text-center">Velocidade de Download</h3>
                <div class="flex justify-center mb-8">
                    <div class="gauge h-32 w-64">
                        <div id="download-gauge-fill" class="gauge-fill"></div>
                        <div class="gauge-center"></div>
                        <div id="download-value" class="gauge-value">0</div>
                        <div class="gauge-label">Mbps</div>
                    </div>
                </div>
                <div class="text-center">
                    <div id="download-progress" class="h-2 w-full bg-gray-200 rounded-full overflow-hidden mb-2">
                        <div class="h-full bg-green-500 w-0 transition-all duration-300"></div>
                    </div>
                    <p id="download-status" class="text-sm text-gray-500">Aguardando teste...</p>
                </div>
            </div>
            
            <!-- Medidor de Upload -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-lg font-semibold mb-4 text-center">Velocidade de Upload</h3>
                <div class="flex justify-center mb-8">
                    <div class="gauge h-32 w-64">
                        <div id="upload-gauge-fill" class="gauge-fill"></div>
                        <div class="gauge-center"></div>
                        <div id="upload-value" class="gauge-value">0</div>
                        <div class="gauge-label">Mbps</div>
                    </div>
                </div>
                <div class="text-center">
                    <div id="upload-progress" class="h-2 w-full bg-gray-200 rounded-full overflow-hidden mb-2">
                        <div class="h-full bg-purple-500 w-0 transition-all duration-300"></div>
                    </div>
                    <p id="upload-status" class="text-sm text-gray-500">Aguardando teste...</p>
                </div>
            </div>
            
            <!-- Medidor de Ping -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-lg font-semibold mb-4 text-center">Latência (Ping)</h3>
                <div class="flex justify-center mb-8">
                    <div class="gauge h-32 w-64">
                        <div id="ping-gauge-fill" class="gauge-fill"></div>
                        <div class="gauge-center"></div>
                        <div id="ping-value" class="gauge-value">0</div>
                        <div class="gauge-label">ms</div>
                    </div>
                </div>
                <div class="text-center">
                    <div id="ping-progress" class="h-2 w-full bg-gray-200 rounded-full overflow-hidden mb-2">
                        <div class="h-full bg-yellow-500 w-0 transition-all duration-300"></div>
                    </div>
                    <p id="ping-status" class="text-sm text-gray-500">Aguardando teste...</p>
                </div>
            </div>
        </div>
        
        <!-- Resultados -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 class="text-xl font-semibold mb-4">Resultados Detalhados</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Hora</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Download</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Upload</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ping</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jitter</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conexão</th>
                        </tr>
                    </thead>
                    <tbody id="results-table" class="bg-white divide-y divide-gray-200">
                        <!-- Resultados serão adicionados aqui -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Gráfico de Histórico -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 class="text-xl font-semibold mb-4">Histórico de Testes</h2>
            <div class="h-64">
                <canvas id="history-chart"></canvas>
            </div>
        </div>
        
        <!-- Recomendações -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 class="text-xl font-semibold mb-4">Recomendações</h2>
            <div id="recommendations" class="space-y-2">
                <p class="text-gray-500">Complete um teste para receber recomendações personalizadas.</p>
            </div>
        </div>
    </div>

    <script>
        // Elementos DOM
        const startTestBtn = document.getElementById('start-test');
        const testDownloadBtn = document.getElementById('test-download');
        const testUploadBtn = document.getElementById('test-upload');
        const testPingBtn = document.getElementById('test-ping');
        const downloadValue = document.getElementById('download-value');
        const uploadValue = document.getElementById('upload-value');
        const pingValue = document.getElementById('ping-value');
        const downloadGaugeFill = document.getElementById('download-gauge-fill');
        const uploadGaugeFill = document.getElementById('upload-gauge-fill');
        const pingGaugeFill = document.getElementById('ping-gauge-fill');
        const downloadProgress = document.getElementById('download-progress').querySelector('div');
        const uploadProgress = document.getElementById('upload-progress').querySelector('div');
        const pingProgress = document.getElementById('ping-progress').querySelector('div');
        const downloadStatus = document.getElementById('download-status');
        const uploadStatus = document.getElementById('upload-status');
        const pingStatus = document.getElementById('ping-status');
        const resultsTable = document.getElementById('results-table');
        const connectionType = document.getElementById('connection-type');
        const ispInfo = document.getElementById('isp-info');
        const ipAddress = document.getElementById('ip-address');
        const locationInfo = document.getElementById('location-info');
        const recommendations = document.getElementById('recommendations');

        // Variáveis globais
        let testHistory = [];
        let chart = null;
        let testInProgress = false;
        let connectionInfo = {
            type: 'Desconhecido',
            isp: 'Desconhecido',
            ip: 'Desconhecido',
            location: 'Desconhecido'
        };

        // Inicializar gráfico
        function initChart() {
            const ctx = document.getElementById('history-chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Download (Mbps)',
                            data: [],
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'Upload (Mbps)',
                            data: [],
                            borderColor: 'rgb(168, 85, 247)',
                            backgroundColor: 'rgba(168, 85, 247, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'Ping (ms)',
                            data: [],
                            borderColor: 'rgb(234, 179, 8)',
                            backgroundColor: 'rgba(234, 179, 8, 0.1)',
                            tension: 0.1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Velocidade (Mbps)'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Ping (ms)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Testes'
                            }
                        }
                    }
                }
            });
        }

        // Função para atualizar o medidor
        function updateGauge(gaugeElement, value, maxValue) {
            // Calcular ângulo (180 graus é o máximo)
            const percentage = Math.min(value / maxValue, 1);
            const angle = percentage * 180;
            gaugeElement.style.transform = `rotate(${angle}deg)`;
            
            // Atualizar cor com base na porcentagem
            if (percentage < 0.3) {
                gaugeElement.style.backgroundColor = '#ef4444'; // Vermelho
            } else if (percentage < 0.7) {
                gaugeElement.style.backgroundColor = '#f59e0b'; // Amarelo
            } else {
                gaugeElement.style.backgroundColor = '#10b981'; // Verde
            }
        }

        // Função para atualizar a barra de progresso
        function updateProgress(progressElement, percentage) {
            progressElement.style.width = `${percentage}%`;
        }

        // Função para detectar informações de conexão
        async function detectConnectionInfo() {
            try {
                // Detectar tipo de conexão
                if (navigator.connection) {
                    connectionInfo.type = navigator.connection.effectiveType || 'Desconhecido';
                    connectionType.textContent = connectionInfo.type.toUpperCase();
                }
                
                // Obter informações de IP e localização
                const response = await fetch('https://ipinfo.io/json');
                const data = await response.json();
                
                connectionInfo.ip = data.ip || 'Desconhecido';
                connectionInfo.isp = data.org || 'Desconhecido';
                connectionInfo.location = data.city && data.country ? `${data.city}, ${data.country}` : 'Desconhecido';
                
                ipAddress.textContent = connectionInfo.ip;
                ispInfo.textContent = connectionInfo.isp.replace(/^AS\d+\s/, ''); // Remover prefixo AS
                locationInfo.textContent = connectionInfo.location;
            } catch (error) {
                console.error('Erro ao obter informações de conexão:', error);
                connectionType.textContent = 'Erro ao detectar';
                ipAddress.textContent = 'Erro ao detectar';
                ispInfo.textContent = 'Erro ao detectar';
                locationInfo.textContent = 'Erro ao detectar';
            }
        }

        // Função para testar ping
        async function testPing() {
            if (testInProgress) return;
            testInProgress = true;
            
            pingStatus.textContent = 'Testando ping...';
            updateProgress(pingProgress, 20);
            
            try {
                const startTime = performance.now();
                
                // Fazer várias requisições para calcular média
                const pingCount = 5;
                let totalPing = 0;
                let jitter = 0;
                let lastPing = 0;
                let pings = [];
                
                for (let i = 0; i < pingCount; i++) {
                    updateProgress(pingProgress, 20 + (i * 15));
                    
                    // Usar um timestamp para evitar cache
                    const response = await fetch(`https://www.google.com/generate_204?t=${Date.now()}`);
                    const endTime = performance.now();
                    const pingTime = endTime - startTime;
                    
                    pings.push(pingTime);
                    totalPing += pingTime;
                    
                    if (i > 0) {
                        jitter += Math.abs(pingTime - lastPing);
                    }
                    
                    lastPing = pingTime;
                    
                    // Pequena pausa entre pings
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                // Calcular média e jitter
                const avgPing = Math.round(totalPing / pingCount);
                jitter = Math.round(jitter / (pingCount - 1));
                
                // Atualizar UI
                pingValue.textContent = avgPing;
                updateGauge(pingGaugeFill, avgPing, 200); // 200ms como valor máximo
                updateProgress(pingProgress, 100);
                pingStatus.textContent = `Ping: ${avgPing}ms, Jitter: ${jitter}ms`;
                
                return { ping: avgPing, jitter };
            } catch (error) {
                console.error('Erro ao testar ping:', error);
                pingStatus.textContent = 'Erro ao testar ping';
                updateProgress(pingProgress, 0);
                return null;
            } finally {
                testInProgress = false;
            }
        }

        // Função para testar velocidade de download
        async function testDownload() {
            if (testInProgress) return;
            testInProgress = true;
            
            downloadStatus.textContent = 'Iniciando teste de download...';
            updateProgress(downloadProgress, 10);
            
            try {
                // Tamanho do arquivo de teste (em bytes)
                const testSizes = [1000000, 2000000, 5000000, 10000000]; // 1MB, 2MB, 5MB, 10MB
                let totalSpeed = 0;
                let testCount = 0;
                
                for (let i = 0; i < testSizes.length; i++) {
                    const fileSize = testSizes[i];
                    
                    downloadStatus.textContent = `Baixando arquivo de teste ${i+1}/${testSizes.length}...`;
                    updateProgress(downloadProgress, 10 + (i * 20));
                    
                    // Usar um timestamp para evitar cache
                    const url = `https://speed.cloudflare.com/__down?bytes=${fileSize}&t=${Date.now()}`;
                    const startTime = performance.now();
                    
                    try {
                        const response = await fetch(url);
                        const data = await response.blob();
                        const endTime = performance.now();
                        
                        // Calcular velocidade em Mbps
                        const durationSeconds = (endTime - startTime) / 1000;
                        const fileSizeMb = fileSize / 1000000 * 8; // Converter para megabits
                        const speedMbps = fileSizeMb / durationSeconds;
                        
                        totalSpeed += speedMbps;
                        testCount++;
                        
                        // Atualizar UI durante o teste
                        const currentSpeed = Math.round(speedMbps * 10) / 10;
                        downloadValue.textContent = currentSpeed;
                        updateGauge(downloadGaugeFill, currentSpeed, 100); // 100 Mbps como valor máximo
                    } catch (error) {
                        console.error(`Erro no teste ${i+1}:`, error);
                    }
                    
                    // Pequena pausa entre testes
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                // Calcular média final
                const avgSpeed = testCount > 0 ? Math.round((totalSpeed / testCount) * 10) / 10 : 0;
                
                // Atualizar UI final
                downloadValue.textContent = avgSpeed;
                updateGauge(downloadGaugeFill, avgSpeed, 100);
                updateProgress(downloadProgress, 100);
                downloadStatus.textContent = `Velocidade média: ${avgSpeed} Mbps`;
                
                return avgSpeed;
            } catch (error) {
                console.error('Erro ao testar download:', error);
                downloadStatus.textContent = 'Erro ao testar download';
                updateProgress(downloadProgress, 0);
                return null;
            } finally {
                testInProgress = false;
            }
        }

        // Função para testar velocidade de upload
        async function testUpload() {
            if (testInProgress) return;
            testInProgress = true;
            
            uploadStatus.textContent = 'Iniciando teste de upload...';
            updateProgress(uploadProgress, 10);
            
            try {
                // Tamanhos de teste para upload (em bytes)
                const testSizes = [500000, 1000000, 2000000]; // 500KB, 1MB, 2MB
                let totalSpeed = 0;
                let testCount = 0;
                
                for (let i = 0; i < testSizes.length; i++) {
                    const dataSize = testSizes[i];
                    
                    uploadStatus.textContent = `Enviando dados de teste ${i+1}/${testSizes.length}...`;
                    updateProgress(uploadProgress, 10 + (i * 25));
                    
                    // Criar dados aleatórios para upload
                    const randomData = new Uint8Array(dataSize);
                    crypto.getRandomValues(randomData);
                    const blob = new Blob([randomData]);
                    
                    // Enviar dados
                    const startTime = performance.now();
                    
                    try {
                        const formData = new FormData();
                        formData.append('file', blob, 'speedtest.bin');
                        
                        const response = await fetch('https://speed.cloudflare.com/__up', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const endTime = performance.now();
                        
                        // Calcular velocidade em Mbps
                        const durationSeconds = (endTime - startTime) / 1000;
                        const dataSizeMb = dataSize / 1000000 * 8; // Converter para megabits
                        const speedMbps = dataSizeMb / durationSeconds;
                        
                        totalSpeed += speedMbps;
                        testCount++;
                        
                        // Atualizar UI durante o teste
                        const currentSpeed = Math.round(speedMbps * 10) / 10;
                        uploadValue.textContent = currentSpeed;
                        updateGauge(uploadGaugeFill, currentSpeed, 50); // 50 Mbps como valor máximo
                    } catch (error) {
                        console.error(`Erro no teste de upload ${i+1}:`, error);
                    }
                    
                    // Pequena pausa entre testes
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                // Calcular média final
                const avgSpeed = testCount > 0 ? Math.round((totalSpeed / testCount) * 10) / 10 : 0;
                
                // Atualizar UI final
                uploadValue.textContent = avgSpeed;
                updateGauge(uploadGaugeFill, avgSpeed, 50);
                updateProgress(uploadProgress, 100);
                uploadStatus.textContent = `Velocidade média: ${avgSpeed} Mbps`;
                
                return avgSpeed;
            } catch (error) {
                console.error('Erro ao testar upload:', error);
                uploadStatus.textContent = 'Erro ao testar upload';
                updateProgress(uploadProgress, 0);
                return null;
            } finally {
                testInProgress = false;
            }
        }

        // Função para executar teste completo
        async function runFullTest() {
            if (testInProgress) return;
            
            // Resetar UI
            startTestBtn.disabled = true;
            testDownloadBtn.disabled = true;
            testUploadBtn.disabled = true;
            testPingBtn.disabled = true;
            
            startTestBtn.textContent = 'Teste em andamento...';
            
            // Executar testes
            const pingResult = await testPing();
            const downloadResult = await testDownload();
            const uploadResult = await testUpload();
            
            // Registrar resultados
            if (pingResult && downloadResult !== null && uploadResult !== null) {
                const testResult = {
                    timestamp: new Date(),
                    download: downloadResult,
                    upload: uploadResult,
                    ping: pingResult.ping,
                    jitter: pingResult.jitter,
                    connection: connectionInfo.type
                };
                
                testHistory.push(testResult);
                addResultToTable(testResult);
                updateChart();
                generateRecommendations(testResult);
                
                // Salvar no localStorage
                try {
                    localStorage.setItem('speedTestHistory', JSON.stringify(testHistory));
                } catch (e) {
                    console.error('Erro ao salvar histórico:', e);
                }
            }
            
            // Restaurar UI
            startTestBtn.disabled = false;
            testDownloadBtn.disabled = false;
            testUploadBtn.disabled = false;
            testPingBtn.disabled = false;
            
            startTestBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
                Iniciar Teste Completo
            `;
        }

        // Função para adicionar resultado à tabela
        function addResultToTable(result) {
            const row = document.createElement('tr');
            
            // Formatar data
            const date = new Date(result.timestamp);
            const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${getSpeedClass(result.download)}">${result.download} Mbps</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${getSpeedClass(result.upload)}">${result.upload} Mbps</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${getPingClass(result.ping)}">${result.ping} ms</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.jitter} ms</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.connection}</td>
            `;
            
            resultsTable.prepend(row);
        }

        // Função para obter classe de cor com base na velocidade
        function getSpeedClass(speed) {
            if (speed < 5) return 'text-red-600';
            if (speed < 15) return 'text-yellow-600';
            return 'text-green-600';
        }

        // Função para obter classe de cor com base no ping
        function getPingClass(ping) {
            if (ping > 100) return 'text-red-600';
            if (ping > 50) return 'text-yellow-600';
            return 'text-green-600';
        }

        // Função para atualizar o gráfico
        function updateChart() {
            if (!chart) return;
            
            // Limitar a 10 entradas para melhor visualização
            const displayHistory = testHistory.slice(-10);
            
            chart.data.labels = displayHistory.map((_, index) => `Teste ${index + 1}`);
            chart.data.datasets[0].data = displayHistory.map(item => item.download);
            chart.data.datasets[1].data = displayHistory.map(item => item.upload);
            chart.data.datasets[2].data = displayHistory.map(item => item.ping);
            
            chart.update();
        }

        // Função para gerar recomendações
        function generateRecommendations(result) {
            let recommendationHTML = '';
            
            // Avaliar velocidade de download
            if (result.download < 5) {
                recommendationHTML += `
                    <div class="p-3 bg-red-50 border border-red-200 rounded-md">
                        <h3 class="font-medium text-red-800">Velocidade de download muito baixa</h3>
                        <p class="text-red-700">Sua velocidade de download de ${result.download} Mbps é insuficiente para streaming de vídeo HD e downloads de arquivos grandes.</p>
                        <ul class="list-disc list-inside text-sm text-red-700 mt-2">
                            <li>Verifique se outros dispositivos estão usando sua conexão</li>
                            <li>Reinicie seu roteador</li>
                            <li>Considere atualizar seu plano de internet</li>
                        </ul>
                    </div>
                `;
            } else if (result.download < 15) {
                recommendationHTML += `
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                        <h3 class="font-medium text-yellow-800">Velocidade de download moderada</h3>
                        <p class="text-yellow-700">Sua velocidade de download de ${result.download} Mbps é adequada para navegação básica e streaming em qualidade padrão, mas pode ser insuficiente para múltiplos dispositivos.</p>
                    </div>
                `;
            } else {
                recommendationHTML += `
                    <div class="p-3 bg-green-50 border border-green-200 rounded-md">
                        <h3 class="font-medium text-green-800">Boa velocidade de download</h3>
                        <p class="text-green-700">Sua velocidade de download de ${result.download} Mbps é adequada para a maioria das atividades online, incluindo streaming em HD.</p>
                    </div>
                `;
            }
            
            // Avaliar velocidade de upload
            if (result.upload < 2) {
                recommendationHTML += `
                    <div class="p-3 bg-red-50 border border-red-200 rounded-md mt-3">
                        <h3 class="font-medium text-red-800">Velocidade de upload muito baixa</h3>
                        <p class="text-red-700">Sua velocidade de upload de ${result.upload} Mbps pode causar problemas em videochamadas e ao compartilhar arquivos.</p>
                    </div>
                `;
            } else if (result.upload < 5) {
                recommendationHTML += `
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-md mt-3">
                        <h3 class="font-medium text-yellow-800">Velocidade de upload moderada</h3>
                        <p class="text-yellow-700">Sua velocidade de upload de ${result.upload} Mbps é suficiente para uso básico, mas pode limitar videochamadas em alta qualidade.</p>
                    </div>
                `;
            } else {
                recommendationHTML += `
                    <div class="p-3 bg-green-50 border border-green-200 rounded-md mt-3">
                        <h3 class="font-medium text-green-800">Boa velocidade de upload</h3>
                        <p class="text-green-700">Sua velocidade de upload de ${result.upload} Mbps é adequada para videochamadas e compartilhamento de arquivos.</p>
                    </div>
                `;
            }
            
            // Avaliar ping
            if (result.ping > 100) {
                recommendationHTML += `
                    <div class="p-3 bg-red-50 border border-red-200 rounded-md mt-3">
                        <h3 class="font-medium text-red-800">Latência alta</h3>
                        <p class="text-red-700">Seu ping de ${result.ping}ms pode causar atrasos perceptíveis em jogos online e videochamadas.</p>
                        <ul class="list-disc list-inside text-sm text-red-700 mt-2">
                            <li>Use conexão com cabo em vez de Wi-Fi</li>
                            <li>Feche aplicativos que consomem banda</li>
                            <li>Verifique se há interferência no sinal Wi-Fi</li>
                        </ul>
                    </div>
                `;
            } else if (result.ping > 50) {
                recommendationHTML += `
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-md mt-3">
                        <h3 class="font-medium text-yellow-800">Latência moderada</h3>
                        <p class="text-yellow-700">Seu ping de ${result.ping}ms é aceitável para a maioria das atividades, mas pode não ser ideal para jogos competitivos.</p>
                    </div>
                `;
            } else {
                recommendationHTML += `
                    <div class="p-3 bg-green-50 border border-green-200 rounded-md mt-3">
                        <h3 class="font-medium text-green-800">Latência excelente</h3>
                        <p class="text-green-700">Seu ping de ${result.ping}ms é ótimo para todas as atividades online, incluindo jogos competitivos.</p>
                    </div>
                `;
            }
            
            recommendations.innerHTML = recommendationHTML;
        }

        // Carregar histórico do localStorage
        function loadHistory() {
            try {
                const savedHistory = localStorage.getItem('speedTestHistory');
                if (savedHistory) {
                    testHistory = JSON.parse(savedHistory);
                    
                    // Converter strings de data para objetos Date
                    testHistory.forEach(item => {
                        if (typeof item.timestamp === 'string') {
                            item.timestamp = new Date(item.timestamp);
                        }
                    });
                    
                    // Adicionar à tabela
                    testHistory.forEach(result => addResultToTable(result));
                    
                    // Atualizar gráfico
                    updateChart();
                }
            } catch (e) {
                console.error('Erro ao carregar histórico:', e);
            }
        }

        // Event Listeners
        startTestBtn.addEventListener('click', runFullTest);
        testDownloadBtn.addEventListener('click', testDownload);
        testUploadBtn.addEventListener('click', testUpload);
        testPingBtn.addEventListener('click', testPing);

        // Inicialização
        window.addEventListener('load', () => {
            detectConnectionInfo();
            initChart();
            loadHistory();
        });
    </script>
</body>
</html>